<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Platform Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        #gameCanvas {
            display: block;
            touch-action: none;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: white;
            user-select: none;
            touch-action: none;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }
        #loadingStatus {
            margin-top: 20px;
            color: #ccc;
        }
        #errorMessage {
            color: red;
            margin-top: 20px;
            display: none;
            max-width: 80%;
            text-align: center;
        }
        #forceStartBtn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            display: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <h2>Loading Game Assets</h2>
        <div id="loadingStatus">Loading 0/6</div>
        <div id="errorMessage"></div>
        <button id="forceStartBtn">Force Start Game</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div class="controls">
        <div class="control-btn" id="leftBtn">←</div>
        <div class="control-btn" id="jumpBtn">↑</div>
        <div class="control-btn" id="rightBtn">→</div>
    </div>

<script>
// Debugging and error handling
console.log("Initializing game...");

// DOM elements
const loadingScreen = document.getElementById('loadingScreen');
const loadingStatus = document.getElementById('loadingStatus');
const errorMessage = document.getElementById('errorMessage');
const forceStartBtn = document.getElementById('forceStartBtn');

// Game state
let gameInitialized = false;
let assetsLoaded = 0;
const totalAssets = 6; // Background, GameOver, Live, Player, Enemy, Music

// Update loading status
function updateLoadingStatus() {
    loadingStatus.textContent = `Loading ${assetsLoaded}/${totalAssets}`;
    console.log(`Assets loaded: ${assetsLoaded}/${totalAssets}`);
}

// Show error message
function showError(msg) {
    console.error(msg);
    errorMessage.textContent = msg;
    errorMessage.style.display = 'block';
    forceStartBtn.style.display = 'block';
}

// Canvas setup
const canvas = document.getElementById('gameCanvas');
const context = canvas.getContext('2d');

function resizeCanvas() {
    try {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        console.log(`Canvas resized to: ${canvas.width}x${canvas.height}`);
    } catch (e) {
        showError("Failed to initialize canvas: " + e.message);
    }
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Game assets with error handling
function loadAsset(img, src, name) {
    return new Promise((resolve, reject) => {
        img.onload = () => {
            assetsLoaded++;
            updateLoadingStatus();
            console.log(`Loaded: ${name}`);
            resolve();
        };
        img.onerror = () => {
            showError(`Failed to load: ${name} (${src})`);
            reject(`Failed to load ${name}`);
        };
        img.src = src;
    });
}

// Audio with error handling
function loadAudio(audio, src, name) {
    return new Promise((resolve, reject) => {
        audio.oncanplaythrough = () => {
            assetsLoaded++;
            updateLoadingStatus();
            console.log(`Loaded: ${name}`);
            resolve();
        };
        audio.onerror = () => {
            showError(`Failed to load: ${name} (${src})`);
            reject(`Failed to load ${name}`);
        };
        audio.src = src;
        audio.load();
    });
}

// Load all assets
async function loadAssets() {
    try {
        console.log("Starting asset loading...");
        
        // Load images
        const backgroundImage = new Image();
        const gameOverImage = new Image();
        const lifeImage = new Image();
        const playerSprite = new Image();
        const enemySprite = new Image();
        
        // Load audio
        const music = new Audio();
        
        await Promise.all([
            loadAsset(backgroundImage, 'Background.png', 'Background'),
            loadAsset(gameOverImage, 'GameOver.png', 'Game Over Screen'),
            loadAsset(lifeImage, 'live.png', 'Life Icon'),
            loadAsset(playerSprite, 'Player.png', 'Player Sprite'),
            loadAsset(enemySprite, 'Enemy.png', 'Enemy Sprite'),
            
        ]);
        
        return {
            backgroundImage,
            gameOverImage,
            lifeImage,
            playerSprite,
            enemySprite,
            music
        };
    } catch (e) {
        throw new Error("Asset loading failed: " + e);
    }
}

// Game objects
let player, enemy, platform;

// Initialize game
function initGame(assets) {
    console.log("Initializing game objects...");
    
    // Player
    player = {
        x: 50,
        y: 400,
        width: 100,
        height: 100,
        dx: 0,
        dy: 0,
        gravity: 0.5,
        jumpForce: 12,
        jumping: false,
        sprite: assets.playerSprite,
        lives: 3,
    };

    // Enemy
    enemy = {
        x: 300,
        y: 400,
        width: 50,
        height: 50,
        dx: -2,
        dy: 0,
        gravity: 0.5,
        jumpForce: 10,
        jumping: false,
        sprite: assets.enemySprite,
        rotation: 0,
        dead: false,
    };

    // Platform
    platform = {
        x: 0,
        y: canvas.height - 100,
        width: canvas.width,
        height: 50,
        color: '#0c0'
    };

    gameInitialized = true;
    console.log("Game initialized successfully");
}

// Draw function
function draw() {
    try {
        context.clearRect(0, 0, canvas.width, canvas.height);

        if (gameOver) {
            context.drawImage(assets.gameOverImage, 0, 0, canvas.width, canvas.height);
        } else {
            // Draw background
            context.drawImage(assets.backgroundImage, 0, 0, canvas.width, canvas.height);
            
            // Draw lives
            for (let i = 0; i < player.lives; i++) {
                context.drawImage(assets.lifeImage, 10 + i * 30, 10, 30, 30);
            }

            // Draw player
            context.drawImage(player.sprite, player.x, player.y, player.width, player.height);

            // Draw enemy if not dead
            if (!enemy.dead) {
                context.save();
                context.translate(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                context.rotate(enemy.rotation);
                context.drawImage(enemy.sprite, -enemy.width / 2, -enemy.height / 2, enemy.width, enemy.height);
                context.restore();
            }
        }
    } catch (e) {
        console.error("Drawing error:", e);
    }
}

// Update function
function update() {
    if (gameOver || !gameInitialized) return;
    
    try {
        // Update player position
        player.x += player.dx;
        player.y += player.dy;

        // Collision with enemy
        if (!enemy.dead && 
            player.x < enemy.x + enemy.width && 
            player.x + player.width > enemy.x && 
            player.y < enemy.y + enemy.height && 
            player.y + player.height > enemy.y) {
            player.lives--;
            player.x = 50;
            player.y = 100;
            if (player.lives < 0) gameOver = true;
        }

        // Platform collision
        if (player.y + player.height > platform.y) {
            player.y = platform.y - player.height;
            player.jumping = false;
        } else {
            player.dy += player.gravity;
        }

        // Screen boundaries
        player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
        player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

        // Update enemy
        enemy.x += enemy.dx;
        enemy.y += enemy.dy;
        
        if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
            enemy.dx *= -1;
            enemy.rotation += Math.PI;
        }
        enemy.y = Math.max(0, Math.min(canvas.height - enemy.height, enemy.y));
    } catch (e) {
        console.error("Update error:", e);
    }
}

// Control handlers
function setupControls() {
    console.log("Setting up controls...");
    
    let moveLeft = false;
    let moveRight = false;

    // Left button
    const leftBtn = document.getElementById('leftBtn');
    leftBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        moveLeft = true;
        player.dx = -5;
    });
    leftBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        moveLeft = false;
        if (!moveRight) player.dx = 0;
    });

    // Right button
    const rightBtn = document.getElementById('rightBtn');
    rightBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        moveRight = true;
        player.dx = 5;
    });
    rightBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        moveRight = false;
        if (!moveLeft) player.dx = 0;
    });

    // Jump button
    const jumpBtn = document.getElementById('jumpBtn');
    jumpBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!player.jumping) {
            player.dy = -player.jumpForce;
            player.jumping = true;
            assets.music.play().catch(e => console.log("Audio play failed:", e));
        }
    });

    // Keyboard controls
    window.addEventListener('keydown', (e) => {
        if (e.code === "ArrowLeft") {
            player.dx = -5;
        } else if (e.code === "ArrowRight") {
            player.dx = 5;
        } else if (e.code === "Space" && !player.jumping) {
            player.dy = -player.jumpForce;
            player.jumping = true;
            assets.music.play().catch(e => console.log("Audio play failed:", e));
        }
    });

    window.addEventListener('keyup', (e) => {
        if (e.code === "ArrowLeft" || e.code === "ArrowRight") {
            player.dx = 0;
        }
    });
}

// Game loop
function gameLoop() {
    try {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    } catch (e) {
        console.error("Game loop error:", e);
        showError("Game error: " + e.message);
    }
}

// Main initialization
let assets;
loadAssets()
    .then(loadedAssets => {
        assets = loadedAssets;
        initGame(assets);
        setupControls();
        loadingScreen.style.display = 'none';
        console.log("Starting game loop...");
        gameLoop();
    })
    .catch(e => {
        showError("Game initialization failed. " + e);
    });

// Force start button
forceStartBtn.addEventListener('click', () => {
    if (!gameInitialized) {
        console.warn("Force starting game with potentially missing assets");
        // Create placeholder assets if needed
        if (!assets) {
            assets = {
                backgroundImage: createPlaceholder(800, 600, '#333'),
                gameOverImage: createPlaceholder(800, 600, '#f00'),
                lifeImage: createPlaceholder(30, 30, '#f00'),
                playerSprite: createPlaceholder(100, 100, '#0f0'),
                enemySprite: createPlaceholder(50, 50, '#f00'),
                music: new Audio()
            };
        }
        initGame(assets);
        setupControls();
        loadingScreen.style.display = 'none';
        gameLoop();
    }
});

function createPlaceholder(width, height, color) {
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, width, height);
    const img = new Image();
    img.src = canvas.toDataURL();
    return img;
}
</script>
</body>
</html>
